From 801844bbd337b80f4ada24b9d37e7aab395ae42e Mon Sep 17 00:00:00 2001
From: Xin Ouyang <Xin.Ouyang@windriver.com>
Date: Mon, 28 Jan 2019 14:13:36 +0800
Subject: [PATCH] refpolicy: add boolean to allow creating unconfined VMs

While using static labeling, admins may want to create VMs running on
unconfined_t domain , by setting a static label
"system_u:system_r:unconfined_t:...".

Add a boolean  and set it to false by default because we do not suggest
to allow this.

Upstream-Status: Inappropriate [configuration]

Signed-off-by: Xin Ouyang <Xin.Ouyang@windriver.com>
---
 policy/modules/services/virt.te     | 14 ++++++++++++++
 policy/modules/system/unconfined.if | 19 +++++++++++++++++++
 2 files changed, 33 insertions(+)

diff --git a/policy/modules/services/virt.te b/policy/modules/services/virt.te
index 3bfdddf..36e9fac 100644
--- a/policy/modules/services/virt.te
+++ b/policy/modules/services/virt.te
@@ -95,6 +95,14 @@ roleattribute system_r virt_bridgehelper_roles;
 attribute_role svirt_lxc_domain_roles;
 roleattribute system_r svirt_lxc_domain_roles;
 
+## <desc>
+## <p>
+## Allow admins to create VMs running on unconfined_t domain, by
+## setting a static label "system_u:system_r:unconfined_t:..."
+## </p>
+## </desc>
+gen_tunable(virt_allow_unconfined_vm, false)
+
 virt_domain_template(svirt)
 virt_domain_template(svirt_prot_exec)
 
@@ -458,6 +466,12 @@ tunable_policy(`virt_use_vfio',`
 	dev_rw_vfio_dev(svirt_t)
 ')
 
+optional_policy(`
+	tunable_policy(`virt_allow_unconfined_vm',`
+		unconfined_allow_domtrans(virtd_t)
+	')
+')
+
 ########################################
 #
 # virtd local policy
diff --git a/policy/modules/system/unconfined.if b/policy/modules/system/unconfined.if
index 565e712..06f7d16 100644
--- a/policy/modules/system/unconfined.if
+++ b/policy/modules/system/unconfined.if
@@ -560,3 +560,22 @@ interface(`unconfined_dbus_connect',`
 
 	allow $1 unconfined_t:dbus acquire_svc;
 ')
+
+########################################
+## <summary>
+##	Allow a domain to transition to unconfined domain
+## </summary>
+## <param name="domain">
+##	<summary>
+##	Domain allowed to transition.
+##	</summary>
+## </param>
+#
+interface(`unconfined_allow_domtrans',`
+	gen_require(`
+		type unconfined_t;
+		class process transition;
+	')
+
+	allow $1 unconfined_t:process transition;
+')
-- 
2.7.4

