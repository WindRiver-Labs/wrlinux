Subject: [PATCH] refpolicy: add boolean to allow creating unconfined VMs

While using static labeling, admins may want to create VMs running on
unconfined_t domain , by setting a static label
"system_u:system_r:unconfined_t:...".

Add a boolean  and set it to false by default because we do not suggest
to allow this.

Upstream-Status: Inappropriate [configuration]

Signed-off-by: Xin Ouyang <Xin.Ouyang@windriver.com>
---
 policy/modules/contrib/virt.te      |   14 ++++++++++++++
 policy/modules/system/unconfined.if |   19 +++++++++++++++++++
 2 files changed, 33 insertions(+)

--- refpolicy.orig/policy/modules/contrib/virt.te
+++ refpolicy/policy/modules/contrib/virt.te
@@ -95,6 +95,14 @@ roleattribute system_r virt_bridgehelper
 attribute_role svirt_lxc_domain_roles;
 roleattribute system_r svirt_lxc_domain_roles;
 
+## <desc>
+## <p>
+## Allow admins to create VMs running on unconfined_t domain, by
+## setting a static label "system_u:system_r:unconfined_t:..."
+## </p>
+## </desc>
+gen_tunable(virt_allow_unconfined_vm, false)
+
 virt_domain_template(svirt)
 virt_domain_template(svirt_prot_exec)
 
@@ -446,6 +454,12 @@ tunable_policy(`virt_use_vfio',`
 	dev_rw_vfio_dev(svirt_t)
 ')
 
+optional_policy(`
+	tunable_policy(`virt_allow_unconfined_vm',`
+		unconfined_allow_domtrans(virtd_t)
+	')
+')
+
 ########################################
 #
 # virtd local policy
--- refpolicy.orig/policy/modules/system/unconfined.if
+++ refpolicy/policy/modules/system/unconfined.if
@@ -587,3 +587,22 @@ interface(`unconfined_dbus_connect',`
 
 	allow $1 unconfined_t:dbus acquire_svc;
 ')
+
+########################################
+## <summary>
+##	Allow a domain to transition to unconfined domain
+## </summary>
+## <param name="domain">
+##	<summary>
+##	Domain allowed to transition.
+##	</summary>
+## </param>
+#
+interface(`unconfined_allow_domtrans',`
+	gen_require(`
+		type unconfined_t;
+		class process transition;
+	')
+
+	allow $1 unconfined_t:process transition;
+')
