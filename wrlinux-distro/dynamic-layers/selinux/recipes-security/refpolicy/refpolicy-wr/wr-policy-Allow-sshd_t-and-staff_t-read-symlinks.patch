From afcb1430339223c100cb5b9e25fb4a0e568aaf20 Mon Sep 17 00:00:00 2001
From: Liwei Song <liwei.song@windriver.com>
Date: Fri, 21 Feb 2020 11:23:19 +0800
Subject: [PATCH 1/3] Allow sshd_t and staff_t read symlinks

when enable ostree, root directory is symlink, sshd_t and staff_t
do not have permission to access link file, add rules to allow
this kind of access.
add rules when root is label or dircetory to userdomain, alias in
file_contexts.subs_dist for root will stop label for /root if it
is symlink file.

fix the following denials:
AVC avc:  denied  { read } for  pid=733 comm="sshd" name="root"
dev="sdb3" ino=861 scontext=system_u:system_r:sshd_t:s0-s15:c0.c1023
tcontext=root:object_r:user_home_dir_t:s0 tclass=lnk_file permissive=0

AVC avc:  denied  { read } for  pid=733 comm="sh" name="root"
dev="sdb3" ino=861 scontext=root:staff_r:staff_t:s0-s15:c0.c1023
tcontext=root:object_r:user_home_dir_t:s0 tclass=lnk_file permissive=0

Upstream-Status: Pending

Signed-off-by: Liwei Song <liwei.song@windriver.com>
---
 config/file_contexts.subs_dist      | 1 -
 policy/modules/roles/staff.te       | 1 +
 policy/modules/services/ssh.te      | 2 ++
 policy/modules/system/userdomain.fc | 2 ++
 4 files changed, 5 insertions(+), 1 deletion(-)

diff --git a/config/file_contexts.subs_dist b/config/file_contexts.subs_dist
index e29d7f484662..ecf48dbc39fe 100644
--- a/config/file_contexts.subs_dist
+++ b/config/file_contexts.subs_dist
@@ -51,5 +51,4 @@
 /run/systemd/system /usr/lib/systemd/system
 /run/systemd/generator /usr/lib/systemd/system
 /etc/systemd/system /usr/lib/systemd/system
-/root /home/root
 /usr/etc /etc
diff --git a/policy/modules/roles/staff.te b/policy/modules/roles/staff.te
index ad96def248e6..aa4f06e10f2b 100644
--- a/policy/modules/roles/staff.te
+++ b/policy/modules/roles/staff.te
@@ -14,6 +14,7 @@ userdom_unpriv_user_template(staff)
 # Local policy
 #
 corenet_ib_access_unlabeled_pkeys(staff_t)
+files_read_all_symlinks(staff_t)
 
 optional_policy(`
 	apache_role(staff_r, staff_t)
diff --git a/policy/modules/services/ssh.te b/policy/modules/services/ssh.te
index 21dd5342ca21..99acee9da79e 100644
--- a/policy/modules/services/ssh.te
+++ b/policy/modules/services/ssh.te
@@ -87,6 +87,8 @@ typealias ssh_home_t alias { home_ssh_t user_ssh_home_t user_home_ssh_t staff_ho
 typealias ssh_home_t alias { auditadm_home_ssh_t secadm_home_ssh_t };
 userdom_user_home_content(ssh_home_t)
 
+files_read_all_symlinks(sshd_t)
+
 type sshd_keytab_t;
 files_type(sshd_keytab_t)
 
diff --git a/policy/modules/system/userdomain.fc b/policy/modules/system/userdomain.fc
index 70b830585cc4..9144dbeb73e7 100644
--- a/policy/modules/system/userdomain.fc
+++ b/policy/modules/system/userdomain.fc
@@ -1,6 +1,8 @@
 HOME_DIR	-d	gen_context(system_u:object_r:user_home_dir_t,s0-mls_systemhigh)
 HOME_DIR/.+		gen_context(system_u:object_r:user_home_t,s0)
 HOME_DIR/\.pki(/.*)?	gen_context(system_u:object_r:user_cert_t,s0)
+/root		-d	gen_context(root:object_r:user_home_dir_t,s0)
+/root		-l	gen_context(root:object_r:user_home_dir_t,s0)
 
 /tmp/gconfd-%{USERNAME} -d	gen_context(system_u:object_r:user_tmp_t,s0)
 
-- 
2.17.1

