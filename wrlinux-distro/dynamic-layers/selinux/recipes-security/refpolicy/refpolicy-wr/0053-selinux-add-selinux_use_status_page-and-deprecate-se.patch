From d47552b5042de9ac4c0265dded45ec324f7ad9f1 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Christian=20G=C3=B6ttsche?= <cgzones@googlemail.com>
Date: Wed, 9 Sep 2020 20:56:12 +0200
Subject: [PATCH] selinux: add selinux_use_status_page and deprecate
 selinux_map_security_files
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Christian GÃ¶ttsche <cgzones@googlemail.com>

Upstream-Status: Backport
[https://github.com/SELinuxProject/refpolicy/commit/24827d807379302f5e6d31389911292d304136a1]

Signed-off-by: Yi Zhao <yi.zhao@windriver.com>
---
 policy/modules/admin/rpm.te      |  2 +-
 policy/modules/kernel/selinux.if | 25 ++++++++++++++++++++++++-
 policy/modules/system/init.te    |  1 +
 policy/modules/system/systemd.te | 18 +++++++++++++++---
 4 files changed, 41 insertions(+), 5 deletions(-)

diff --git a/policy/modules/admin/rpm.te b/policy/modules/admin/rpm.te
index 6911724e..3245aa06 100644
--- a/policy/modules/admin/rpm.te
+++ b/policy/modules/admin/rpm.te
@@ -181,7 +181,7 @@ selinux_compute_access_vector(rpm_t)
 selinux_compute_create_context(rpm_t)
 selinux_compute_relabel_context(rpm_t)
 selinux_compute_user_contexts(rpm_t)
-selinux_map_security_files(rpm_t)
+selinux_use_status_page(rpm_t)
 
 storage_raw_write_fixed_disk(rpm_t)
 storage_raw_read_fixed_disk(rpm_t)
diff --git a/policy/modules/kernel/selinux.if b/policy/modules/kernel/selinux.if
index 81d8f918..bf70d3c4 100644
--- a/policy/modules/kernel/selinux.if
+++ b/policy/modules/kernel/selinux.if
@@ -637,7 +637,28 @@ interface(`selinux_compute_user_contexts',`
 
 ########################################
 ## <summary>
-##	Allows caller to map secuirty_t files.
+##	Allows the caller to use the SELinux status page.
+## </summary>
+## <param name="domain">
+##	<summary>
+##	Domain allowed access.
+##	</summary>
+## </param>
+## <rolecap/>
+#
+interface(`selinux_use_status_page',`
+	gen_require(`
+		type security_t;
+	')
+
+	dev_search_sysfs($1)
+	allow $1 security_t:dir list_dir_perms;
+	allow $1 security_t:file mmap_read_file_perms;
+')
+
+########################################
+## <summary>
+##	Allows caller to map secuirty_t files. (Deprecated)
 ## </summary>
 ## <param name="domain">
 ##	<summary>
@@ -651,6 +672,8 @@ interface(`selinux_map_security_files',`
 		type security_t;
 	')
 
+	refpolicywarn(`$0() has been deprecated, use selinux_use_status_page() instead.')
+
 	dev_search_sysfs($1)
 	allow $1 security_t:file map;
 ')
diff --git a/policy/modules/system/init.te b/policy/modules/system/init.te
index f34f6365..97ff060a 100644
--- a/policy/modules/system/init.te
+++ b/policy/modules/system/init.te
@@ -448,6 +448,7 @@ ifdef(`init_systemd',`
 	selinux_compute_access_vector(init_t)
 	# for starting systemd --user in the right domain:
 	selinux_compute_user_contexts(init_t)
+	selinux_use_status_page(init_t)
 
 	storage_getattr_removable_dev(init_t)
 
diff --git a/policy/modules/system/systemd.te b/policy/modules/system/systemd.te
index 1ae4cd72..2e258cd7 100644
--- a/policy/modules/system/systemd.te
+++ b/policy/modules/system/systemd.te
@@ -434,6 +434,8 @@ dev_read_sysfs(systemd_hostnamed_t)
 files_read_etc_files(systemd_hostnamed_t)
 fs_search_tmpfs(systemd_hostnamed_t)
 
+selinux_use_status_page(systemd_hostnamed_t)
+
 seutil_read_file_contexts(systemd_hostnamed_t)
 
 sysnet_etc_filetrans_config(systemd_hostnamed_t)
@@ -466,6 +468,7 @@ files_etc_filetrans(systemd_hw_t, systemd_hwdb_t, file)
 files_search_runtime(systemd_hw_t)
 
 selinux_get_fs_mount(systemd_hw_t)
+selinux_use_status_page(systemd_hw_t)
 
 init_read_state(systemd_hw_t)
 
@@ -481,6 +484,8 @@ kernel_read_kernel_sysctls(systemd_locale_t)
 
 files_read_etc_files(systemd_locale_t)
 
+selinux_use_status_page(systemd_locale_t)
+
 seutil_read_file_contexts(systemd_locale_t)
 
 systemd_log_parse_environment(systemd_locale_t)
@@ -572,7 +577,7 @@ fs_read_efivarfs_files(systemd_logind_t)
 fs_relabelfrom_tmpfs_dirs(systemd_logind_t)
 fs_unmount_tmpfs(systemd_logind_t)
 
-selinux_get_enforce_mode(systemd_logind_t)
+selinux_use_status_page(systemd_logind_t)
 
 storage_getattr_removable_dev(systemd_logind_t)
 storage_getattr_scsi_generic_dev(systemd_logind_t)
@@ -1109,6 +1114,8 @@ corenet_udp_bind_generic_node(systemd_resolved_t)
 corenet_udp_bind_dns_port(systemd_resolved_t)
 corenet_udp_bind_llmnr_port(systemd_resolved_t)
 
+selinux_use_status_page(systemd_resolved_t)
+
 auth_use_nsswitch(systemd_resolved_t)
 
 files_watch_root_dirs(systemd_resolved_t)
@@ -1144,8 +1151,8 @@ files_runtime_filetrans(systemd_sessions_t, systemd_sessions_runtime_t, file)
 
 kernel_read_kernel_sysctls(systemd_sessions_t)
 
-selinux_get_enforce_mode(systemd_sessions_t)
 selinux_get_fs_mount(systemd_sessions_t)
+selinux_use_status_page(systemd_sessions_t)
 
 seutil_read_config(systemd_sessions_t)
 seutil_read_default_contexts(systemd_sessions_t)
@@ -1169,6 +1176,8 @@ files_manage_etc_files(systemd_sysusers_t)
 
 kernel_read_kernel_sysctls(systemd_sysusers_t)
 
+selinux_use_status_page(systemd_sysusers_t)
+
 auth_manage_shadow(systemd_sysusers_t)
 auth_etc_filetrans_shadow(systemd_sysusers_t)
 auth_use_nsswitch(systemd_sysusers_t)
@@ -1244,6 +1253,7 @@ fs_relabelfrom_tmpfs_dirs(systemd_tmpfiles_t)
 
 selinux_get_fs_mount(systemd_tmpfiles_t)
 selinux_search_fs(systemd_tmpfiles_t)
+selinux_use_status_page(systemd_tmpfiles_t)
 
 auth_append_lastlog(systemd_tmpfiles_t)
 auth_manage_faillog(systemd_tmpfiles_t)
@@ -1333,6 +1343,8 @@ files_var_filetrans(systemd_update_done_t, systemd_update_run_t, file)
 
 kernel_read_kernel_sysctls(systemd_update_done_t)
 
+selinux_use_status_page(systemd_update_done_t)
+
 seutil_read_file_contexts(systemd_update_done_t)
 
 systemd_log_parse_environment(systemd_update_done_t)
@@ -1426,7 +1438,7 @@ fs_relabelfrom_tmpfs_dirs(systemd_user_runtime_dir_t)
 
 kernel_read_kernel_sysctls(systemd_user_runtime_dir_t)
 
-selinux_get_enforce_mode(systemd_user_runtime_dir_t)
+selinux_use_status_page(systemd_user_runtime_dir_t)
 
 systemd_log_parse_environment(systemd_user_runtime_dir_t)
 systemd_dbus_chat_logind(systemd_user_runtime_dir_t)
-- 
2.17.1

