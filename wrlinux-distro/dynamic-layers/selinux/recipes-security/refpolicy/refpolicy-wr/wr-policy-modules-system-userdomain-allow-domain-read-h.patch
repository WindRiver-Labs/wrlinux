From f23251b4f24ff2ca53c94117f6c6839dee886c9e Mon Sep 17 00:00:00 2001
From: Yi Zhao <yi.zhao@windriver.com>
Date: Tue, 4 Aug 2020 13:19:35 +0800
Subject: [PATCH] policy/modules/system/userdomain: allow domain read home link
 directory

Fixes:
avc:  denied  { read } for  pid=453 comm="alsactl" name="root"
dev="sdb3" ino=1600 scontext=system_u:system_r:alsa_t:s0-s15:c0.c1023
tcontext=root:object_r:user_home_dir_t:s0 tclass=lnk_file permissive=0

avc:  denied  { read } for  pid=1494 comm="lpqd" name="root" dev="sdb3"
ino=1600 scontext=system_u:system_r:smbd_t:s0-s15:c0.c1023
tcontext=root:object_r:user_home_dir_t:s0 tclass=lnk_file permissive=0

Upstream-Status: Inappropriate [ostree specific]

Signed-off-by: Yi Zhao <yi.zhao@windriver.com>
---
 policy/modules/system/userdomain.if | 14 ++++++++++++++
 1 file changed, 14 insertions(+)

diff --git a/policy/modules/system/userdomain.if b/policy/modules/system/userdomain.if
index 9d433c37c..a668e8fce 100644
--- a/policy/modules/system/userdomain.if
+++ b/policy/modules/system/userdomain.if
@@ -1730,6 +1730,7 @@ interface(`userdom_getattr_user_home_dirs',`
 		type user_home_dir_t;
 	')
 
+	allow $1 user_home_dir_t:lnk_file read_lnk_file_perms;
 	allow $1 user_home_dir_t:dir getattr_dir_perms;
 	files_search_home($1)
 ')
@@ -1767,6 +1768,7 @@ interface(`userdom_search_user_home_dirs',`
 		type user_home_dir_t;
 	')
 
+	allow $1 user_home_dir_t:lnk_file read_lnk_file_perms;
 	allow $1 user_home_dir_t:dir search_dir_perms;
 	files_search_home($1)
 ')
@@ -1812,6 +1814,7 @@ interface(`userdom_list_user_home_dirs',`
 		type user_home_dir_t;
 	')
 
+	allow $1 user_home_dir_t:lnk_file read_lnk_file_perms;
 	allow $1 user_home_dir_t:dir list_dir_perms;
 	files_search_home($1)
 ')
@@ -1849,6 +1852,7 @@ interface(`userdom_create_user_home_dirs',`
 		type user_home_dir_t;
 	')
 
+	allow $1 user_home_dir_t:lnk_file read_lnk_file_perms;
 	allow $1 user_home_dir_t:dir create_dir_perms;
 ')
 
@@ -1867,6 +1871,7 @@ interface(`userdom_manage_user_home_dirs',`
 		type user_home_dir_t;
 	')
 
+	allow $1 user_home_dir_t:lnk_file read_lnk_file_perms;
 	allow $1 user_home_dir_t:dir manage_dir_perms;
 ')
 
@@ -1885,6 +1890,7 @@ interface(`userdom_relabelto_user_home_dirs',`
 		type user_home_dir_t;
 	')
 
+	allow $1 user_home_dir_t:lnk_file read_lnk_file_perms;
 	allow $1 user_home_dir_t:dir relabelto;
 ')
 
@@ -1947,6 +1953,7 @@ interface(`userdom_user_home_domtrans',`
 	')
 
 	domain_auto_transition_pattern($1, user_home_t, $2)
+	allow $1 user_home_dir_t:lnk_file read_lnk_file_perms;
 	allow $1 user_home_dir_t:dir search_dir_perms;
 	files_search_home($1)
 ')
@@ -2395,6 +2402,7 @@ interface(`userdom_manage_user_home_content_files',`
 	')
 
 	manage_files_pattern($1, user_home_t, user_home_t)
+	allow $1 user_home_dir_t:lnk_file read_lnk_file_perms;
 	allow $1 user_home_dir_t:dir search_dir_perms;
 	files_search_home($1)
 ')
@@ -2435,6 +2443,7 @@ interface(`userdom_manage_user_home_content_symlinks',`
 	')
 
 	manage_lnk_files_pattern($1, user_home_t, user_home_t)
+	allow $1 user_home_dir_t:lnk_file read_lnk_file_perms;
 	allow $1 user_home_dir_t:dir search_dir_perms;
 	files_search_home($1)
 ')
@@ -2494,6 +2503,7 @@ interface(`userdom_manage_user_home_content_pipes',`
 	')
 
 	manage_fifo_files_pattern($1, user_home_t, user_home_t)
+	allow $1 user_home_dir_t:lnk_file read_lnk_file_perms;
 	allow $1 user_home_dir_t:dir search_dir_perms;
 	files_search_home($1)
 ')
@@ -2514,6 +2524,7 @@ interface(`userdom_manage_user_home_content_sockets',`
 		type user_home_dir_t, user_home_t;
 	')
 
+	allow $1 user_home_dir_t:lnk_file read_lnk_file_perms;
 	allow $1 user_home_dir_t:dir search_dir_perms;
 	manage_sock_files_pattern($1, user_home_t, user_home_t)
 	files_search_home($1)
@@ -2551,6 +2562,7 @@ interface(`userdom_user_home_dir_filetrans',`
 		type user_home_dir_t;
 	')
 
+	read_lnk_files_pattern($1, user_home_dir_t, user_home_dir_t)
 	filetrans_pattern($1, user_home_dir_t, $2, $3, $4)
 	files_search_home($1)
 ')
@@ -2589,6 +2601,7 @@ interface(`userdom_user_home_content_filetrans',`
 	')
 
 	filetrans_pattern($1, user_home_t, $2, $3, $4)
+	allow $1 user_home_dir_t:lnk_file read_lnk_file_perms;
 	allow $1 user_home_dir_t:dir search_dir_perms;
 	files_search_home($1)
 ')
@@ -4309,6 +4322,7 @@ interface(`userdom_search_user_home_content',`
 	')
 
 	files_list_home($1)
+	allow $1 user_home_dir_t:lnk_file read_lnk_file_perms;
 	allow $1 { user_home_dir_t user_home_t }:dir search_dir_perms;
 ')
 
-- 
2.17.1

