From 11e95a1e5656fdba0fe0e6078950689875d6cfbe Mon Sep 17 00:00:00 2001
From: Wenzong Fan <wenzong.fan@windriver.com>
Date: Mon, 23 Jan 2017 08:42:44 +0000
Subject: [PATCH] refpolicy: fix systemd-logind fails to start

Reference sources: selinux-policy-3.13.1-225.6.fc25.src.rpm
Changes come from: policy-f25-base.patch
                   policy-f25-contrib.patch

* Allow system_dbusd_t read systemd_login PID files
 (systemd_logind_var_run_t)

* Allow systemd_logind_t write all levels files

* Fix avc denials:

  avc: denied { read open getattr } for pid=319 comm="systemd-logind" \
  name="file_contexts.subs_dist" dev="vda" ino=95 \
  scontext=system_u:system_r:systemd_logind_t:s0-s15:c0.c1023 \
  tcontext=system_u:object_r:file_context_t:s0 tclass=file

  avc: denied { write add_name } for pid=319 comm="systemd-logind" \
  name="user" dev="tmpfs" ino=9638 \
  scontext=system_u:system_r:systemd_logind_t:s0-s15:c0.c1023 \
  tcontext=system_u:object_r:user_runtime_root_t:s0 tclass=dir

  avc: denied { create mounton relabelto search } for pid=319 \
  comm="systemd-logind" name="0" \
  scontext=system_u:system_r:systemd_logind_t:s0-s15:c0.c1023 \
  tcontext=root:object_r:user_runtime_t:s0 tclass=dir

  ...

Upstream-Status: Pending

Signed-off-by: Wenzong Fan <wenzong.fan@windriver.com>
---
 policy/modules/system/systemd.te | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/policy/modules/system/systemd.te b/policy/modules/system/systemd.te
index 5459213..565fd6e 100644
--- a/policy/modules/system/systemd.te
+++ b/policy/modules/system/systemd.te
@@ -514,6 +514,7 @@ kernel_read_system_state(systemd_logind_t)
 auth_manage_var_auth(systemd_logind_t)
 
 mls_file_read_all_levels(systemd_logind_t)
+mls_file_write_all_levels(systemd_logind_t)
 
 domain_read_all_domains_state(systemd_logind_t)
 
@@ -554,6 +555,8 @@ userdom_relabelto_user_runtime_dirs(systemd_logind_t)
 userdom_setattr_user_ttys(systemd_logind_t)
 userdom_use_user_ttys(systemd_logind_t)
 
+seutil_read_config(systemd_logind_t)
+
 # Needed to work around patch not yet merged into the systemd-logind supported on RHEL 7.x
 # The change in systemd by Nicolas Iooss on 02-Feb-2016 with hash 4b51966cf6c06250036e428608da92f8640beb96
 # should fix the problem where user directories in /run/user/$UID/ are not getting the proper context
-- 
2.7.4

