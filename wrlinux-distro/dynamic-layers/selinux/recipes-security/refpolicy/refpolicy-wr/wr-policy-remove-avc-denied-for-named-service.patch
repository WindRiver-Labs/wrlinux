From 1b56a392de198e8e848e66a7a2e83556dde3e492 Mon Sep 17 00:00:00 2001
From: Wenzong Fan <wenzong.fan@windriver.com>
Date: Mon, 24 Feb 2014 08:00:01 -0500
Subject: [PATCH] remove avc denied messages for named service

* fix real path for named ROOTDIR
* fix avc denied issues like:

type=AVC msg=audit(1393242619.202:5): avc:  denied  { mounton } for \
pid=509 comm="mount" path="/run/named-chroot/var/run/named" dev= \
"tmpfs" ino=9411 scontext=system_u:system_r:mount_t:s0-s15:c0.c1023 \
tcontext=system_u:object_r:named_var_run_t:s0 tclass=dir

type=AVC msg=audit(1393242620.829:13): avc:  denied  { write } for \
pid=527 comm="named" name="bind" dev="hda" ino=28146 scontext= \
system_u:system_r:named_t:s0-s15:c0.c1023 tcontext= \
system_u:object_r:named_conf_t:s0 tclass=dir

Upstream-Status: Inappropriate [WR Only]

Signed-off-by: Wenzong Fan <wenzong.fan@windriver.com>
---
 policy/modules/kernel/devices.fc   |  5 +++++
 policy/modules/services/bind.fc    | 16 ++++++++++++++++
 policy/modules/services/bind.te    |  3 +++
 policy/modules/services/dbus.fc    |  1 +
 policy/modules/system/logging.fc   |  3 +++
 policy/modules/system/miscfiles.fc |  1 +
 6 files changed, 29 insertions(+)

diff --git a/policy/modules/kernel/devices.fc b/policy/modules/kernel/devices.fc
index 5ec14ac..3d613e3 100644
--- a/policy/modules/kernel/devices.fc
+++ b/policy/modules/kernel/devices.fc
@@ -211,4 +211,9 @@ ifdef(`distro_redhat',`
 /var/named/chroot/dev/null -c	gen_context(system_u:object_r:null_device_t,s0)
 /var/named/chroot/dev/random -c	gen_context(system_u:object_r:random_device_t,s0)
 /var/named/chroot/dev/zero -c	gen_context(system_u:object_r:zero_device_t,s0)
+
+/var/run/named-chroot/dev   -d      gen_context(system_u:object_r:device_t,s0)
+/var/run/named-chroot/dev/null -c   gen_context(system_u:object_r:null_device_t,s0)
+/var/run/named-chroot/dev/random -c gen_context(system_u:object_r:random_device_t,s0)
+/var/run/named-chroot/dev/zero -c   gen_context(system_u:object_r:zero_device_t,s0)
 ')
diff --git a/policy/modules/services/bind.fc b/policy/modules/services/bind.fc
index 59498e2..c870dc0 100644
--- a/policy/modules/services/bind.fc
+++ b/policy/modules/services/bind.fc
@@ -66,3 +66,19 @@
 /run/lwresd/lwresd\.pid	-s	gen_context(system_u:object_r:named_var_run_t,s0)
 /run/named(/.*)?	gen_context(system_u:object_r:named_var_run_t,s0)
 /run/unbound(/.*)?	gen_context(system_u:object_r:named_var_run_t,s0)
+
+/var/run/named-chroot(/.*)? gen_context(system_u:object_r:named_conf_t,s0)
+/var/run/named-chroot/etc/rndc\.key --      gen_context(system_u:object_r:dnssec_t,s0)
+/var/run/named-chroot/etc/named\.conf       --      gen_context(system_u:object_r:named_conf_t,s0)
+/var/run/named-chroot/etc/named\.rfc1912\.zones     --      gen_context(system_u:object_r:named_conf_t,s0)
+/var/run/named-chroot/etc/named\.root\.hints        --      gen_context(system_u:object_r:named_conf_t,s0)
+/var/run/named-chroot/etc/named\.caching-nameserver\.conf   --      gen_context(system_u:object_r:named_conf_t,s0)
+/var/run/named-chroot/proc(/.*)?    <<none>>
+/var/run/named-chroot/var/run/named.*       gen_context(system_u:object_r:named_var_run_t,s0)
+/var/run/named-chroot/var/tmp(/.*)? gen_context(system_u:object_r:named_cache_t,s0)
+/var/run/named-chroot/var/named(/.*)?       gen_context(system_u:object_r:named_zone_t,s0)
+/var/run/named-chroot/var/named/slaves(/.*)?        gen_context(system_u:object_r:named_cache_t,s0)
+/var/run/named-chroot/var/named/data(/.*)?  gen_context(system_u:object_r:named_cache_t,s0)
+/var/run/named-chroot/var/named/dynamic(/.*)?       gen_context(system_u:object_r:named_cache_t,s0)
+/var/run/named-chroot/var/named/named\.ca   --      gen_context(system_u:object_r:named_conf_t,s0)
+/var/run/named-chroot/var/log/named.*       --      gen_context(system_u:object_r:named_log_t,s0)
diff --git a/policy/modules/services/bind.te b/policy/modules/services/bind.te
index c96d0b8..e66082d 100644
--- a/policy/modules/services/bind.te
+++ b/policy/modules/services/bind.te
@@ -59,6 +59,7 @@ init_unit_file(named_unit_t)
 type named_var_run_t;
 files_pid_file(named_var_run_t)
 init_daemon_pid_file(named_var_run_t, dir, "named")
+files_mountpoint(named_var_run_t)
 
 # for primary zone files
 type named_zone_t;
@@ -85,6 +86,7 @@ allow named_t dnssec_t:file read_file_perms;
 
 allow named_t named_conf_t:dir list_dir_perms;
 read_files_pattern(named_t, named_conf_t, named_conf_t)
+manage_dirs_pattern(named_t, named_conf_t, named_conf_t)
 read_lnk_files_pattern(named_t, named_conf_t, named_conf_t)
 
 manage_files_pattern(named_t, named_cache_t, named_cache_t)
@@ -154,6 +156,7 @@ dev_read_urand(named_t)
 domain_use_interactive_fds(named_t)
 
 files_read_etc_runtime_files(named_t)
+files_map_etc_files(named_t)
 files_read_usr_files(named_t)
 
 fs_getattr_all_fs(named_t)
diff --git a/policy/modules/services/dbus.fc b/policy/modules/services/dbus.fc
index e9a13ee..5c65224 100644
--- a/policy/modules/services/dbus.fc
+++ b/policy/modules/services/dbus.fc
@@ -23,6 +23,7 @@ HOME_DIR/\.dbus(/.*)?				gen_context(system_u:object_r:session_dbusd_home_t,s0)
 /var/lib/dbus(/.*)?				gen_context(system_u:object_r:system_dbusd_var_lib_t,s0)
 
 /var/named/chroot/var/run/dbus(/.*)?		gen_context(system_u:object_r:system_dbusd_var_run_t,s0)
+/var/run/named-chroot/var/run/dbus(/.*)?	gen_context(system_u:object_r:system_dbusd_var_run_t,s0)
 
 # /var/run prefix exception; https://dbus.freedesktop.org/doc/dbus-specification.html#idm2461
 /var/run/dbus/system_bus_socket			gen_context(system_u:object_r:system_dbusd_var_run_t,s0)
diff --git a/policy/modules/system/logging.fc b/policy/modules/system/logging.fc
index 39ede06..950819d 100644
--- a/policy/modules/system/logging.fc
+++ b/policy/modules/system/logging.fc
@@ -75,6 +75,9 @@ ifndef(`distro_gentoo',`
 ifdef(`distro_redhat',`
 /var/named/chroot/var/log -d	gen_context(system_u:object_r:var_log_t,s0)
 /var/named/chroot/dev/log -s	gen_context(system_u:object_r:devlog_t,s0)
+
+/var/run/named-chroot/var/log -d    gen_context(system_u:object_r:var_log_t,s0)
+/var/run/named-chroot/dev/log -s    gen_context(system_u:object_r:devlog_t,s0)
 ')
 
 /run/audit_events	-s	gen_context(system_u:object_r:auditd_var_run_t,mls_systemhigh)
diff --git a/policy/modules/system/miscfiles.fc b/policy/modules/system/miscfiles.fc
index 069ce52..0624900 100644
--- a/policy/modules/system/miscfiles.fc
+++ b/policy/modules/system/miscfiles.fc
@@ -83,6 +83,7 @@ ifdef(`distro_redhat',`
 /var/cache/man(/.*)?		gen_context(system_u:object_r:man_cache_t,s0)
 
 /var/named/chroot/etc/pki(/.*)? gen_context(system_u:object_r:cert_t,s0)
+/var/run/named-chroot/etc/pki(/.*)? gen_context(system_u:object_r:cert_t,s0)
 
 /var/spool/abrt-upload(/.*)?	gen_context(system_u:object_r:public_content_rw_t,s0)
 /var/spool/texmf(/.*)?		gen_context(system_u:object_r:tetex_data_t,s0)
-- 
2.7.4

