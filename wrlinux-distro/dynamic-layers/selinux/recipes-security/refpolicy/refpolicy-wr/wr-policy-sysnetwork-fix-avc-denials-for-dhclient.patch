From 6a8aa4b5b7eec9db410fce94e3259f61b7bda13f Mon Sep 17 00:00:00 2001
From: Yi Zhao <yi.zhao@windriver.com>
Date: Tue, 22 Oct 2019 17:54:21 +0800
Subject: [PATCH] sysnetwork: fix avc denials for dhclient

Fix:
dhclient-systemd-wrapper[316]: chown: changing ownership of '/tmp/resolv.conf.dhclient-new': Operation not permitted
dhclient-systemd-wrapper[316]: mv: setting attribute 'security.selinux' for 'security.selinux': Permission denied
dhclient-systemd-wrapper[316]: /etc/dhcp/dhclient.d/ntp.sh: line 31: /etc/ntp.conf: Permission denied

Upstream-Status: Pending

Signed-off-by: Yi Zhao <yi.zhao@windriver.com>
---
 policy/modules/services/ntp.if      | 57 +++++++++++++++++++++++++++++++++++++
 policy/modules/system/sysnetwork.te | 17 ++++++++---
 2 files changed, 70 insertions(+), 4 deletions(-)

diff --git a/policy/modules/services/ntp.if b/policy/modules/services/ntp.if
index 7fa20c8..952aab0 100644
--- a/policy/modules/services/ntp.if
+++ b/policy/modules/services/ntp.if
@@ -36,6 +36,63 @@ interface(`ntp_read_config',`
 
 ########################################
 ## <summary>
+##	Write ntp.conf
+## </summary>
+## <param name="domain">
+##	<summary>
+##	Domain allowed access.
+##	</summary>
+## </param>
+#
+interface(`ntp_write_config',`
+	gen_require(`
+		type ntp_conf_t;
+	')
+
+	files_search_etc($1)
+	allow $1 ntp_conf_t:file write_file_perms;
+')
+
+#######################################
+## <summary>
+##  Create ntp.conf
+## </summary>
+## <param name="domain">
+##  <summary>
+##  Domain allowed access.
+##  </summary>
+## </param>
+#
+interface(`ntp_create_config',`
+	gen_require(`
+		type ntp_conf_t;
+	')
+
+	files_search_etc($1)
+	allow $1 ntp_conf_t:file create_file_perms;
+')
+
+#######################################
+## <summary>
+##  Relabel ntp.conf
+## </summary>
+## <param name="domain">
+##  <summary>
+##  Domain allowed access.
+##  </summary>
+## </param>
+#
+interface(`ntp_relabel_config',`
+	gen_require(`
+		type ntp_conf_t;
+	')
+
+	files_search_etc($1)
+	allow $1 ntp_conf_t:file { relabelfrom relabelto };
+')
+
+########################################
+## <summary>
 ##	Execute ntp server in the ntpd domain.
 ## </summary>
 ## <param name="domain">
diff --git a/policy/modules/system/sysnetwork.te b/policy/modules/system/sysnetwork.te
index 13c783e..1d92aee 100644
--- a/policy/modules/system/sysnetwork.te
+++ b/policy/modules/system/sysnetwork.te
@@ -47,7 +47,7 @@ ifdef(`distro_debian',`
 #
 # DHCP client local policy
 #
-allow dhcpc_t self:capability { dac_override fsetid net_admin net_bind_service net_raw setpcap sys_nice sys_resource sys_tty_config };
+allow dhcpc_t self:capability { dac_override fsetid net_admin net_bind_service net_raw setpcap sys_nice sys_resource sys_tty_config chown sys_admin fowner };
 dontaudit dhcpc_t self:capability { sys_ptrace sys_tty_config };
 # for access("/etc/bashrc", X_OK) on Red Hat
 dontaudit dhcpc_t self:capability { dac_read_search sys_module };
@@ -83,6 +83,10 @@ sysnet_manage_config(dhcpc_t)
 files_etc_filetrans(dhcpc_t, net_conf_t, file)
 files_tmp_filetrans(dhcpc_t, net_conf_t, file, "resolv.conf.dhclient-new")
 
+sysnet_relabel_config(dhcpc_t)
+allow dhcpc_t net_conf_t:file manage_file_perms;
+allow dhcpc_t net_conf_t:file relabel_file_perms;
+
 # create temp files
 manage_dirs_pattern(dhcpc_t, dhcpc_tmp_t, dhcpc_tmp_t)
 manage_files_pattern(dhcpc_t, dhcpc_tmp_t, dhcpc_tmp_t)
@@ -159,9 +163,7 @@ sysnet_run_ifconfig(dhcpc_t, dhcpc_roles)
 userdom_use_user_terminals(dhcpc_t)
 userdom_dontaudit_search_user_home_dirs(dhcpc_t)
 
-ifdef(`distro_redhat', `
-	files_exec_etc_files(dhcpc_t)
-')
+files_exec_etc_files(dhcpc_t)
 
 ifdef(`distro_ubuntu',`
 	optional_policy(`
@@ -178,6 +180,12 @@ ifdef(`init_systemd',`
 ')
 
 optional_policy(`
+	ntp_create_config(dhcpc_t)
+	ntp_write_config(dhcpc_t)
+	ntp_relabel_config(dhcpc_t)
+')
+
+optional_policy(`
 	avahi_domtrans(dhcpc_t)
 ')
 
@@ -257,6 +265,7 @@ optional_policy(`
 optional_policy(`
 	seutil_sigchld_newrole(dhcpc_t)
 	seutil_dontaudit_search_config(dhcpc_t)
+	seutil_domtrans_setfiles(dhcpc_t)
 ')
 
 optional_policy(`
-- 
2.7.4

