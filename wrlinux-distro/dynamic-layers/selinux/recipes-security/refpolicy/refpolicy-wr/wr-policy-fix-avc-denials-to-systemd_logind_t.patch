From e0ed3a3dd7a1157359bd3cff071a1a41611c3450 Mon Sep 17 00:00:00 2001
From: Wenzong Fan <wenzong.fan@windriver.com>
Date: Thu, 3 Mar 2016 07:15:05 -0500
Subject: [PATCH] wr-policy: fix avc denials to systemd_logind_t

Reference sources: selinux-policy-3.13.1-128.21.fc22.src.rpm
Changes come from: policy-f22-base.patch

* Allow systemd_logind_t reboot/halt/stop system

  Note: there's not access vector "stop" for system operations in
  Fedora 22, it defined "undefined" instead.

* Allow systemd_logind_t list tmpfs_t dir, umount tmpfs_t filesystems

* Get systemd_logind_t create /run/user/* with type user_tmp_t

Fix avc denials:

  avc: denied { stop } for auid=n/a uid=0 gid=0 \
  cmdline="/lib/systemd/systemd-logind" \
  scontext=system_u:system_r:systemd_logind_t:s0-s15:c0.c1023 \
  tcontext=system_u:system_r:init_t:s0-s15:c0.c1023 \
  tclass=system permissive=0

  avc: denied { read } for pid=373 comm="systemd-logind" \
  name="/" dev="tmpfs" ino=25737 \
  scontext=system_u:system_r:systemd_logind_t:s0-s15:c0.c1023 \
  tcontext=system_u:object_r:tmpfs_t:s0 \
  tclass=dir permissive=0

  avc: denied { write } for pid=356 comm="systemd-logind" \
  name="systemd" dev="tmpfs" ino=19291 \
  scontext=system_u:system_r:systemd_logind_t:s0-s15:c0.c1023 \
  tcontext=system_u:object_r:tmpfs_t:s0 \
  tclass=dir permissive=0

  avc: denied { unmount } for pid=373 comm="systemd-logind" \
  scontext=system_u:system_r:systemd_logind_t:s0-s15:c0.c1023 \
  tcontext=system_u:object_r:tmpfs_t:s0 \
  tclass=filesystem permissive=0

Upstream-Status: Pending

Signed-off-by: Wenzong Fan <wenzong.fan@windriver.com>
---
 policy/modules/system/systemd.te | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/policy/modules/system/systemd.te b/policy/modules/system/systemd.te
index 2a337a7..db00454 100644
--- a/policy/modules/system/systemd.te
+++ b/policy/modules/system/systemd.te
@@ -504,6 +504,8 @@ init_start_all_units(systemd_logind_t)
 init_stop_all_units(systemd_logind_t)
 init_start_system(systemd_logind_t)
 init_stop_system(systemd_logind_t)
+init_reboot_system(systemd_logind_t)
+init_shutdown_system(systemd_logind_t)
 
 init_dgram_send(systemd_logind_t)
 init_write_pid_socket(systemd_logind_t)
-- 
2.7.4

