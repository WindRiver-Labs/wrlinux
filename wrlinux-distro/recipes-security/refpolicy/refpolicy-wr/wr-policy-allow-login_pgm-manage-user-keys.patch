From 3efcc6772b6d06a6ec454bd6381633b09aa02c37 Mon Sep 17 00:00:00 2001
From: Wenzong Fan <wenzong.fan@windriver.com>
Date: Wed, 8 Apr 2015 15:40:54 +0800
Subject: [PATCH] refpolicy: allow login_pgm manage user keys

Reference sources: selinux-policy-3.12.1-196.fc20.src.rpm
Changes come from: policy-f20-base.patch

* allow login_pgm manage keys for all user domains

Upstream-Status: Pending

Signed-off-by: Wenzong Fan <wenzong.fan@windriver.com>
---
 policy/modules/system/authlogin.if | 2 ++
 policy/modules/system/authlogin.te | 4 ++++
 2 files changed, 6 insertions(+)

diff --git a/policy/modules/system/authlogin.if b/policy/modules/system/authlogin.if
index c7efda9..072ca7c 100644
--- a/policy/modules/system/authlogin.if
+++ b/policy/modules/system/authlogin.if
@@ -112,9 +112,11 @@ interface(`auth_use_pam_systemd',`
 interface(`auth_login_pgm_domain',`
 	gen_require(`
 		type var_auth_t, auth_cache_t;
+		attribute login_pgm;
 	')
 
 	domain_type($1)
+	typeattribute $1 login_pgm;
 	domain_subj_id_change_exemption($1)
 	domain_role_change_exemption($1)
 	domain_obj_id_change_exemption($1)
diff --git a/policy/modules/system/authlogin.te b/policy/modules/system/authlogin.te
index 06bbba0..5e58023 100644
--- a/policy/modules/system/authlogin.te
+++ b/policy/modules/system/authlogin.te
@@ -17,6 +17,7 @@ attribute can_read_shadow_passwords;
 attribute can_write_shadow_passwords;
 attribute can_relabelto_shadow_passwords;
 attribute nsswitch_domain;
+attribute login_pgm;
 
 type auth_cache_t;
 logging_log_file(auth_cache_t)
@@ -472,3 +473,6 @@ optional_policy(`
 	samba_read_var_files(nsswitch_domain)
 	samba_dontaudit_write_var_files(nsswitch_domain)
 ')
+
+# manage keys for all user domains
+userdom_manage_all_users_keys(login_pgm)
-- 
2.7.4

