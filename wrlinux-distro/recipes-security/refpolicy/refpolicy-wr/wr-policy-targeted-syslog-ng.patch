From 053690edb0db0b523c775429cd1856aa1e02e4f5 Mon Sep 17 00:00:00 2001
From: Xin Ouyang <Xin.Ouyang@windriver.com>
Date: Mon, 28 Jan 2019 12:52:32 +0800
Subject: [PATCH] refpolicy: fix policy for syslog-ng

syslog-ng in WRLinux intends to create sockfiles and pid file in
${localstatedir}/run/${PN}, add a allow rule for this.

Default syslog-ng config appends (warn..emerg) messages to /dev/tty10
and /dev/xconsole, also fix this.

Upstream-Status: Inappropriate [configuration]

Signed-off-by: Xin Ouyang <Xin.Ouyang@windriver.com>
---
 policy/modules/system/logging.te | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/policy/modules/system/logging.te b/policy/modules/system/logging.te
index 826d9ea..3e8684c 100644
--- a/policy/modules/system/logging.te
+++ b/policy/modules/system/logging.te
@@ -437,6 +437,7 @@ files_search_var_lib(syslogd_t)
 
 # manage pid file
 manage_files_pattern(syslogd_t, syslogd_var_run_t, syslogd_var_run_t)
+manage_sock_files_pattern(syslogd_t, syslogd_var_run_t, syslogd_var_run_t)
 allow syslogd_t syslogd_var_run_t:file map;
 
 files_pid_filetrans(syslogd_t, syslogd_var_run_t, file)
@@ -517,6 +518,12 @@ init_read_utmp(syslogd_t)
 init_dontaudit_write_utmp(syslogd_t)
 term_write_all_ttys(syslogd_t)
 
+# default syslog-ng config appends (warn..emerg) messages to /dev/tty10
+term_append_unallocated_ttys(syslogd_t)
+term_dontaudit_setattr_unallocated_ttys(syslogd_t)
+term_use_all_ttys(syslogd_t)
+term_use_all_ptys(syslogd_t)
+
 auth_use_nsswitch(syslogd_t)
 
 init_use_fds(syslogd_t)
@@ -621,6 +628,7 @@ optional_policy(`
 optional_policy(`
 	# log to the xconsole
 	xserver_rw_console(syslogd_t)
+	xserver_setattr_console_pipes(syslogd_t)
 ')
 
 
-- 
2.7.4

