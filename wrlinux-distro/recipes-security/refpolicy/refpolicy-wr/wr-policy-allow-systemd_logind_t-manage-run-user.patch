From 2d6f2e939807644b50e34cc5f43823c2276aab88 Mon Sep 17 00:00:00 2001
From: Wenzong Fan <wenzong.fan@windriver.com>
Date: Thu, 25 Feb 2016 05:42:52 -0500
Subject: [PATCH] wr-policy: allow systemd_logind_t manage /run/user*

Reference sources: selinux-policy-3.13.1-128.21.fc22.src.rpm
Changes come from: policy-f22-base.patch

* label /run/user* with type user_tmp_t
* allow systemd_logind_t to /run/user*

Fix avc denial issue:

  avc: denied { mounton } for pid=343 comm="systemd-logind" \
  path="/run/user/0" dev="tmpfs" ino=18496 \
  scontext=system_u:system_r:systemd_logind_t:s0-s15:c0.c1023 \
  tcontext=system_u:object_r:var_auth_t:s0 \
  tclass=dir permissive=1

Upstream-Status: Pending

Signed-off-by: Wenzong Fan <wenzong.fan@windriver.com>
---
 policy/modules/system/authlogin.if  |  2 ++
 policy/modules/system/systemd.te    |  3 ++
 policy/modules/system/userdomain.if | 61 +++++++++++++++++++++++++++++++++++++
 policy/modules/system/userdomain.te |  3 ++
 4 files changed, 69 insertions(+)

diff --git a/policy/modules/system/authlogin.if b/policy/modules/system/authlogin.if
index 6e98c0e..2a3c8ef 100644
--- a/policy/modules/system/authlogin.if
+++ b/policy/modules/system/authlogin.if
@@ -61,6 +61,8 @@ interface(`auth_use_pam',`
 	logging_send_audit_msgs($1)
 	logging_send_syslog_msg($1)
 
+	userdom_search_user_tmp_dirs($1)
+
 	optional_policy(`
 		dbus_system_bus_client($1)
 
diff --git a/policy/modules/system/systemd.te b/policy/modules/system/systemd.te
index 4823560..037d2f0 100644
--- a/policy/modules/system/systemd.te
+++ b/policy/modules/system/systemd.te
@@ -492,6 +492,9 @@ auth_manage_var_auth(systemd_logind_t)
 
 mls_file_read_all_levels(systemd_logind_t)
 
+userdom_manage_all_user_tmp_content(systemd_logind_t)
+userdom_mounton_tmp_dirs(systemd_logind_t)
+
 locallogin_read_state(systemd_logind_t)
 
 seutil_libselinux_linked(systemd_logind_t)
diff --git a/policy/modules/system/userdomain.if b/policy/modules/system/userdomain.if
index ec5f108..984f58c 100644
--- a/policy/modules/system/userdomain.if
+++ b/policy/modules/system/userdomain.if
@@ -4479,3 +4479,64 @@ interface(`userdom_dontaudit_rw_all_users_stream_sockets',`
 
 	dontaudit $1 userdomain:unix_stream_socket rw_socket_perms;
 ')
+
+########################################
+## <summary>
+##      Manage all user temporary content.
+## </summary>
+## <param name="domain">
+##      <summary>
+##      Domain allowed access.
+##      </summary>
+## </param>
+#
+interface(`userdom_manage_all_user_tmp_content',`
+	gen_require(`
+		attribute user_tmp_type;
+	')
+
+	manage_dirs_pattern($1, user_tmp_type, user_tmp_type)
+	manage_files_pattern($1, user_tmp_type, user_tmp_type)
+	manage_lnk_files_pattern($1, user_tmp_type, user_tmp_type)
+	manage_sock_files_pattern($1, user_tmp_type, user_tmp_type)
+	manage_fifo_files_pattern($1, user_tmp_type, user_tmp_type)
+	files_search_tmp($1)
+')
+
+#######################################
+## <summary>
+##      Manage user temporary directories
+## </summary>
+## <param name="domain">
+##      <summary>
+##      Domain allowed access.
+##      </summary>
+## </param>
+## <rolebase/>
+#
+interface(`userdom_mounton_tmp_dirs',`
+	gen_require(`
+		type user_tmp_t;
+	')
+
+	allow $1 user_tmp_t:dir mounton;
+')
+
+########################################
+## <summary>
+##      Search user tmp directories.
+## </summary>
+## <param name="domain">
+##      <summary>
+##      Domain allowed access.
+##      </summary>
+## </param>
+#
+interface(`userdom_search_user_tmp_dirs',`
+	gen_require(`
+		type user_tmp_t;
+	')
+
+	files_search_tmp($1)
+	allow $1 user_tmp_t:dir search_dir_perms;
+')
diff --git a/policy/modules/system/userdomain.te b/policy/modules/system/userdomain.te
index 93faf37..0ec2461 100644
--- a/policy/modules/system/userdomain.te
+++ b/policy/modules/system/userdomain.te
@@ -110,6 +110,9 @@ typealias user_tmp_t alias { staff_untrusted_content_tmp_t sysadm_untrusted_cont
 files_tmp_file(user_tmp_t)
 userdom_user_home_content(user_tmp_t)
 
+attribute user_tmp_type;
+typeattribute user_tmp_t user_tmp_type;
+
 type user_tmpfs_t alias { staff_tmpfs_t sysadm_tmpfs_t secadm_tmpfs_t auditadm_tmpfs_t unconfined_tmpfs_t };
 files_tmpfs_file(user_tmpfs_t)
 userdom_user_home_content(user_tmpfs_t)
-- 
2.7.4

