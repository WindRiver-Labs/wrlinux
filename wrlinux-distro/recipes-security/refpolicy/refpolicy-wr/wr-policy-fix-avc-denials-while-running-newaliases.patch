From fab246d3f7907f2b217bc53a7c17f7247b6b039f Mon Sep 17 00:00:00 2001
From: Wenzong Fan <wenzong.fan@windriver.com>
Date: Fri, 26 Feb 2016 07:24:57 -0500
Subject: [PATCH] wr-policy: fix avc denials while running newaliases

* allow user_mail_t, sendmail_t search /run/systemd/journal which
  labeled as mls_systemhigh
* allow user_mail_t manage etc_aliases_t files
* allow postfix_master_t create etc_aliases_t files

Fix avc denials:

  avc: denied { search } for pid=886 comm="newaliases" \
  name="journal" dev="tmpfs" ino=8228 \
  scontext=root:sysadm_r:user_mail_t:s0-s15:c0.c1023 \
  tcontext=system_u:object_r:syslogd_var_run_t:s15:c0.c1023 \
  tclass=dir permissive=0

  avc: denied { search } for pid=510 comm="newaliases" \
  name="journal" dev="tmpfs" ino=8228 \
  scontext=system_u:system_r:sendmail_t:s0-s15:c0.c1023 \
  tcontext=system_u:object_r:syslogd_var_run_t:s15:c0.c1023 \
  tclass=dir permissive=0

  avc: denied { write } for pid=922 comm="postalias" \
  name="etc" dev="hda" ino=12 \
  scontext=root:sysadm_r:user_mail_t:s0-s15:c0.c1023 \
  tcontext=system_u:object_r:etc_t:s0 \
  tclass=dir permissive=0

  avc: denied { create } for pid=510 comm="postalias" \
  name="__db.aliases.db" \
  scontext=system_u:system_r:postfix_master_t:s0-s15:c0.c1023 \
  tcontext=system_u:object_r:etc_t:s0 \
  tclass=file permissive=0

Upstream-Status: Pending

Signed-off-by: Wenzong Fan <wenzong.fan@windriver.com>
---
 policy/modules/services/mta.te      |  8 ++++++++
 policy/modules/services/postfix.te  | 13 +++++++++++++
 policy/modules/services/sendmail.te |  2 ++
 3 files changed, 23 insertions(+)

diff --git a/policy/modules/services/mta.te b/policy/modules/services/mta.te
index d2f3a94..2a8cf08 100644
--- a/policy/modules/services/mta.te
+++ b/policy/modules/services/mta.te
@@ -416,6 +416,14 @@ dev_read_sysfs(user_mail_t)
 
 userdom_use_user_terminals(user_mail_t)
 
+# WRL fix:
+# create /etc/aliases* with type etc_aliases_t
+files_etc_filetrans(user_mail_t, etc_aliases_t, { file lnk_file sock_file fifo_file })
+# create, read, write, and delete mail address aliases
+mta_manage_aliases(user_mail_t)
+
+mls_file_read_all_levels(user_mail_t)
+
 optional_policy(`
 	allow user_mail_t self:capability dac_override;
 
diff --git a/policy/modules/services/postfix.te b/policy/modules/services/postfix.te
index c3dde8e..9095570 100644
--- a/policy/modules/services/postfix.te
+++ b/policy/modules/services/postfix.te
@@ -324,6 +324,10 @@ mta_read_sendmail_bin(postfix_master_t)
 mta_getattr_spool(postfix_master_t)
 mls_file_read_all_levels(postfix_master_t)
 
+# WRL fix:
+# create /etc/__db.aliases.db with type etc_aliases_t
+mta_etc_filetrans_aliases(postfix_master_t, file, "__db.aliases.db")
+
 optional_policy(`
 	cyrus_stream_connect(postfix_master_t)
 ')
@@ -414,6 +418,7 @@ manage_dirs_pattern(postfix_cleanup_t, postfix_spool_t, postfix_spool_t)
 manage_files_pattern(postfix_cleanup_t, postfix_spool_t, postfix_spool_t)
 manage_lnk_files_pattern(postfix_cleanup_t, postfix_spool_t, postfix_spool_t)
 files_spool_filetrans(postfix_cleanup_t, postfix_spool_t, dir)
+files_map_etc_files(postfix_cleanup_t)
 
 allow postfix_cleanup_t postfix_spool_bounce_t:dir list_dir_perms;
 
@@ -460,6 +465,8 @@ corecmd_exec_bin(postfix_local_t)
 
 logging_dontaudit_search_logs(postfix_local_t)
 
+files_map_etc_files(postfix_local_t)
+
 mta_delete_spool(postfix_local_t)
 mta_read_aliases(postfix_local_t)
 mta_map_aliases(postfix_local_t)
@@ -578,6 +585,8 @@ allow postfix_pickup_t postfix_spool_maildrop_t:dir list_dir_perms;
 read_files_pattern(postfix_pickup_t, postfix_spool_maildrop_t, postfix_spool_maildrop_t)
 delete_files_pattern(postfix_pickup_t, postfix_spool_maildrop_t, postfix_spool_maildrop_t)
 
+files_map_etc_files(postfix_pickup_t)
+
 mcs_file_read_all(postfix_pickup_t)
 mcs_file_write_all(postfix_pickup_t)
 
@@ -649,6 +658,8 @@ allow postfix_postdrop_t postfix_local_t:unix_stream_socket { read write };
 # for /var/spool/postfix/public/pickup
 stream_connect_pattern(postfix_postdrop_t, postfix_public_t, postfix_public_t, postfix_master_t)
 
+files_map_etc_files(postfix_postdrop_t)
+
 mcs_file_read_all(postfix_postdrop_t)
 mcs_file_write_all(postfix_postdrop_t)
 
@@ -733,6 +744,8 @@ manage_files_pattern(postfix_qmgr_t, postfix_spool_t, postfix_spool_t)
 manage_lnk_files_pattern(postfix_qmgr_t, postfix_spool_t, postfix_spool_t)
 files_spool_filetrans(postfix_qmgr_t, postfix_spool_t, dir)
 
+files_map_etc_files(postfix_qmgr_t)
+
 corecmd_exec_bin(postfix_qmgr_t)
 
 mls_file_read_all_levels(postfix_qmgr_t)
diff --git a/policy/modules/services/sendmail.te b/policy/modules/services/sendmail.te
index d5272a4..3d8c281 100644
--- a/policy/modules/services/sendmail.te
+++ b/policy/modules/services/sendmail.te
@@ -127,6 +127,8 @@ mta_manage_spool(sendmail_t)
 mta_read_config(sendmail_t)
 mta_sendmail_exec(sendmail_t)
 
+mls_file_read_all_levels(sendmail_t)
+
 optional_policy(`
 	cfengine_dontaudit_write_log_files(sendmail_t)
 ')
-- 
2.7.4

