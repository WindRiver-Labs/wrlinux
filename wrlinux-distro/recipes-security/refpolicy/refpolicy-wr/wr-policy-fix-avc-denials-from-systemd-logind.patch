From de3f3e01bf8e492c2fad4aa33e5c9945a1edf11e Mon Sep 17 00:00:00 2001
From: Wenzong Fan <wenzong.fan@windriver.com>
Date: Thu, 21 Jan 2016 01:06:36 -0500
Subject: [PATCH] wr-policy-fix-avc-denials-from-systemd-logind

Patches ported from Fedora 22.

Reference sources: selinux-policy-3.13.1-128.21.fc22.src.rpm
Changes come from: policy-f22-base.patch

Fix avc denials:

  avc: denied { net_admin } for pid=328 comm="login" capability=12 \
  scontext=system_u:system_r:local_login_t:s0-s15:c0.c1023 \
  tcontext=system_u:system_r:local_login_t:s0-s15:c0.c1023 \
  tclass=capability permissive=1

  avc: denied { setfscreate } for pid=271 comm="systemd-logind" \
  scontext=system_u:system_r:systemd_logind_t:s0-s15:c0.c1023 \
  tcontext=system_u:system_r:systemd_logind_t:s0-s15:c0.c1023 \
  tclass=process permissive=1

  avc: denied { status start } for auid=n/a uid=0 gid=0 \
  cmdline="/lib/systemd/systemd-logind" \
  scontext=system_u:system_r:systemd_logind_t:s0-s15:c0.c1023 \
  tcontext=system_u:system_r:init_t:s0-s15:c0.c1023 \
  tclass=system exe="/lib/systemd/systemd"

  avc: denied { sendto } for pid=271 comm="systemd-logind" \
  path="/run/systemd/notify" \
  scontext=system_u:system_r:systemd_logind_t:s0-s15:c0.c1023 \
  tcontext=system_u:system_r:init_t:s0-s15:c0.c1023 \
  tclass=unix_dgram_socket permissive=1

  avc: denied { write } for pid=271 comm="systemd-logind" \
  name="notify" dev="tmpfs" ino=8180 \
  scontext=system_u:system_r:systemd_logind_t:s0-s15:c0.c1023 \
  tcontext=system_u:object_r:init_var_run_t:s0 \
  tclass=sock_file permissive=1

  avc: denied { read } for pid=271 comm="systemd-logind" \
  name="cmdline" dev="proc" ino=4026531990 \
  scontext=system_u:system_r:systemd_logind_t:s0-s15:c0.c1023 \
  tcontext=system_u:object_r:proc_t:s0 tclass=file permissive=1

  avc: denied { read } for pid=271 comm="systemd-logind" \
  name="boot_id" dev="proc" ino=9003 \
  scontext=system_u:system_r:systemd_logind_t:s0-s15:c0.c1023 \
  tcontext=system_u:object_r:sysctl_kernel_t:s0 \
  tclass=file permissive=1

  avc: denied { read } for pid=271 comm="systemd-logind" \
  name="master-of-seat" dev="tmpfs" ino=9425 \
  scontext=system_u:system_r:systemd_logind_t:s0-s15:c0.c1023 \
  tcontext=system_u:object_r:udev_var_run_t:s0 \
  tclass=dir permissive=1

  avc: denied { mount } for pid=271 comm="systemd-logind" \
  name="/" dev="tmpfs" ino=17394 \
  scontext=system_u:system_r:systemd_logind_t:s0-s15:c0.c1023 \
  tcontext=system_u:object_r:tmpfs_t:s0 \
  tclass=filesystem permissive=1

  avc: denied { getattr write } for pid=271 comm="systemd-logind" \
  path="/run/user" dev="tmpfs" ino=9472 \
  scontext=system_u:system_r:systemd_logind_t:s0-s15:c0.c1023 \
  tcontext=system_u:object_r:var_auth_t:s0 \
  tclass=dir permissive=1

  avc: denied { add_name create } for pid=271 \
  comm="systemd-logind" name="0" \
  scontext=system_u:system_r:systemd_logind_t:s0-s15:c0.c1023 \
  tcontext=system_u:object_r:var_auth_t:s0 \
  tclass=dir permissive=1

Upstream-Status: pending

Signed-off-by: Wenzong Fan <wenzong.fan@windriver.com>
---
 policy/modules/system/systemd.te | 6 ++++++
 policy/modules/system/udev.if    | 3 +++
 2 files changed, 9 insertions(+)

diff --git a/policy/modules/system/systemd.te b/policy/modules/system/systemd.te
index f6455f6..f64d69c 100644
--- a/policy/modules/system/systemd.te
+++ b/policy/modules/system/systemd.te
@@ -458,6 +458,7 @@ dev_setattr_video_dev(systemd_logind_t)
 domain_obj_id_change_exemption(systemd_logind_t)
 
 files_read_etc_files(systemd_logind_t)
+files_map_etc_files(systemd_logind_t)
 files_search_pids(systemd_logind_t)
 
 fs_getattr_cgroup(systemd_logind_t)
@@ -493,6 +494,11 @@ init_stop_all_units(systemd_logind_t)
 init_start_system(systemd_logind_t)
 init_stop_system(systemd_logind_t)
 
+init_dgram_send(systemd_logind_t)
+init_write_pid_socket(systemd_logind_t)
+kernel_read_system_state(systemd_logind_t)
+auth_manage_var_auth(systemd_logind_t)
+
 locallogin_read_state(systemd_logind_t)
 
 seutil_libselinux_linked(systemd_logind_t)
diff --git a/policy/modules/system/udev.if b/policy/modules/system/udev.if
index 3028d6b..5090b67 100644
--- a/policy/modules/system/udev.if
+++ b/policy/modules/system/udev.if
@@ -384,7 +384,10 @@ interface(`udev_read_pid_files',`
 	')
 
 	files_search_pids($1)
+	# port changes from fedora
+	allow $1 udev_var_run_t:dir list_dir_perms;
 	read_files_pattern($1, udev_var_run_t, udev_var_run_t)
+	read_lnk_files_pattern($1, udev_var_run_t, udev_var_run_t)
 ')
 
 ########################################
-- 
2.7.4

